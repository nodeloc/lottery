(()=>{var t={n:o=>{var e=o&&o.__esModule?()=>o.default:()=>o;return t.d(e,{a:e}),e},d:(o,e)=>{for(var n in e)t.o(e,n)&&!t.o(o,n)&&Object.defineProperty(o,n,{enumerable:!0,get:e[n]})},o:(t,o)=>Object.prototype.hasOwnProperty.call(t,o),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},o={};(()=>{"use strict";t.r(o),t.d(o,{components:()=>it,extend:()=>wt,models:()=>pt});const e=flarum.core.compat["forum/app"];var n=t.n(e);const a=flarum.core.compat["common/extend"],r=flarum.core.compat["common/components/Badge"];var s=t.n(r);const i=flarum.core.compat["forum/components/DiscussionList"];var l=t.n(i);const c=flarum.core.compat["common/models/Discussion"];var u=t.n(c);const d=flarum.core.compat["common/utils/classList"];var p=t.n(d);const h=flarum.core.compat["forum/components/DiscussionComposer"];var y=t.n(h);const f=flarum.core.compat["forum/components/ReplyComposer"];var v=t.n(f);function b(t,o){return b=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,o){return t.__proto__=o,t},b(t,o)}function g(t,o){t.prototype=Object.create(o.prototype),t.prototype.constructor=t,b(t,o)}const w=flarum.core.compat["common/components/Button"];var V=t.n(w);const L=flarum.core.compat["common/components/Modal"];var x=t.n(L);const N=flarum.core.compat["common/components/Switch"];var M=t.n(N);const O=flarum.core.compat["common/utils/ItemList"];var C=t.n(O);const _=flarum.core.compat["common/utils/Stream"];var D=t.n(_);const I=flarum.core.compat["common/utils/extractText"];var S=t.n(I),k=function(t){function o(){return t.apply(this,arguments)||this}g(o,t);var e=o.prototype;return e.oninit=function(o){var e=this;t.prototype.oninit.call(this,o),this.options=[D()(""),D()("")],this.optionImageUrls=[D()(""),D()("")],this.question=D()(""),this.endDate=D()(),this.publicLottery=D()(!1),this.hideVotes=D()(!1),this.allowChangeVote=D()(!0),this.allowMultipleVotes=D()(!1),this.maxVotes=D()(0),this.datepickerMinDate=this.formatDate(void 0);var n=this.attrs.lottery;n&&Array.isArray(n.options)&&(this.options=[],this.optionImageUrls=[],n.options.forEach((function(t){e.options.push(D()(t.answer)),e.optionImageUrls.push(D()(t.imageUrl))})),this.question(n.question),this.publicLottery(n.publicLottery),this.hideVotes(n.hideVotes),this.allowChangeVote(n.allowChangeVote),this.allowMultipleVotes(n.allowMultipleVotes),this.maxVotes(n.maxVotes||0),this.endDate(this.formatDate(n.endDate)),this.endDate()&&dayjs(n.endDate).isAfter(dayjs())&&(this.datepickerMinDate=this.formatDate(n.endDate)))},e.title=function(){return n().translator.trans("nodeloc-lottery.forum.modal.add_title")},e.className=function(){return"LotteryDiscussionModal Modal--medium"},e.content=function(){return[m("div",{className:"Modal-body"},m("div",{className:"LotteryDiscussionModal-form"},this.fields().toArray()))]},e.fields=function(){var t=new(C());return t.add("question",m("div",{className:"Form-group"},m("label",{className:"label"},n().translator.trans("nodeloc-lottery.forum.modal.lottery_placeholder")),m("input",{type:"text",name:"question",className:"FormControl",bidi:this.question})),100),t.add("answers",m("div",{className:"LotteryModal--answers Form-group"},m("label",{className:"label LotteryModal--answers-title"},m("span",null,n().translator.trans("nodeloc-lottery.forum.modal.options_label")),V().component({className:"Button LotteryModal--button small",icon:"fas fa-plus",onclick:this.addOption.bind(this)})),this.displayOptions()),80),t.add("date",m("div",{className:"Form-group"},m("label",{className:"label"},n().translator.trans("nodeloc-lottery.forum.modal.date_placeholder")),m("div",{className:"LotteryModal--date"},m("input",{className:"FormControl",type:"datetime-local",name:"date",bidi:this.endDate,min:this.datepickerMinDate,max:this.formatDate("2038")}),V().component({className:"Button LotteryModal--button",icon:"fas fa-times",onclick:this.endDate.bind(this,null)})),this.endDate()&&m("p",{className:"helpText"},m("i",{class:"icon fas fa-clock"}),"Â ",dayjs(this.endDate()).isBefore(dayjs())?n().translator.trans("nodeloc-lottery.forum.lottery_ended"):n().translator.trans("nodeloc-lottery.forum.days_remaining",{time:dayjs(this.endDate()).fromNow()}))),40),t.add("public",m("div",{className:"Form-group"},M().component({state:this.publicLottery()||!1,onchange:this.publicLottery},n().translator.trans("nodeloc-lottery.forum.modal.public_lottery_label"))),20),t.add("hide-votes",m("div",{className:"Form-group"},m(M(),{state:this.endDate()&&this.hideVotes(),onchange:this.hideVotes,disabled:!this.endDate()},n().translator.trans("nodeloc-lottery.forum.modal.hide_votes_label"))),20),t.add("allow-change-vote",m("div",{className:"Form-group"},m(M(),{state:this.allowChangeVote(),onchange:this.allowChangeVote},n().translator.trans("nodeloc-lottery.forum.modal.allow_change_vote_label"))),20),t.add("allow-multiple-votes",m("div",{className:"Form-group"},M().component({state:this.allowMultipleVotes()||!1,onchange:this.allowMultipleVotes},n().translator.trans("nodeloc-lottery.forum.modal.allow_multiple_votes_label"))),15),this.allowMultipleVotes()&&t.add("max-votes",m("div",{className:"Form-group"},m("label",{className:"label"},n().translator.trans("nodeloc-lottery.forum.modal.max_votes_label")),m("input",{type:"number",min:"0",max:this.options.length,name:"maxVotes",className:"FormControl",bidi:this.maxVotes}),m("p",{className:"helpText"},n().translator.trans("nodeloc-lottery.forum.modal.max_votes_help"))),15),t.add("submit",m("div",{className:"Form-group"},V().component({type:"submit",className:"Button Button--primary LotteryModal-SubmitButton",loading:this.loading},n().translator.trans("nodeloc-lottery.forum.modal.submit"))),-10),t},e.displayOptions=function(){var t=this;return Object.keys(this.options).map((function(o,e){return m("div",{className:"Form-group"},m("fieldset",{className:"Lottery-answer-input"},m("input",{className:"FormControl",type:"text",name:"answer"+(e+1),bidi:t.options[e],placeholder:n().translator.trans("nodeloc-lottery.forum.modal.option_placeholder")+" #"+(e+1)}),n().forum.attribute("allowLotteryOptionImage")?m("input",{className:"FormControl",type:"text",name:"answerImage"+(e+1),bidi:t.optionImageUrls[e],placeholder:n().translator.trans("nodeloc-lottery.forum.modal.image_option_placeholder")+" #"+(e+1)}):null),e>=2?V().component({type:"button",className:"Button Button--warning LotteryModal--button",icon:"fas fa-minus",onclick:e>=2?t.removeOption.bind(t,e):""}):"")}))},e.addOption=function(){var t=Math.max(n().forum.attribute("lotteryMaxOptions"),2);this.options.length<t?(this.options.push(D()("")),this.optionImageUrls.push(D()(""))):alert(S()(n().translator.trans("nodeloc-lottery.forum.modal.max",{max:t})))},e.removeOption=function(t){this.options.splice(t,1),this.optionImageUrls.splice(t,1)},e.data=function(){var t=this,o={question:this.question(),endDate:this.dateToTimestamp(this.endDate()),publicLottery:this.publicLottery(),hideVotes:this.hideVotes(),allowChangeVote:this.allowChangeVote(),allowMultipleVotes:this.allowMultipleVotes(),maxVotes:this.maxVotes(),options:[]};return this.options.forEach((function(e,n){e()&&o.options.push({answer:e(),imageUrl:t.optionImageUrls[n]()})})),""===this.question()?(alert(n().translator.trans("nodeloc-lottery.forum.modal.include_question")),null):o.options.length<2?(alert(n().translator.trans("nodeloc-lottery.forum.modal.min")),null):o},e.onsubmit=function(t){var o=this;t.preventDefault();var e=this.data();if(null!==e){var a=this.attrs.onsubmit(e);a instanceof Promise?(this.loading=!0,a.then(this.hide.bind(this),(function(t){console.error(t),o.onerror(t),o.loaded()}))):n().modal.close()}},e.formatDate=function(t,o){void 0===o&&(o=!1);var e=dayjs(t);return!1!==t&&e.isValid()?e.format("YYYY-MM-DDTHH:mm"):!1!==o?this.formatDate(o):null},e.dateToTimestamp=function(t){var o=dayjs(t);return!(!t||!o.isValid())&&o.format()},o}(x()),A=function(t){t.prototype.addLottery=function(){var t=this;n().modal.show(k,{lottery:this.composer.fields.lottery,onsubmit:function(o){return t.composer.fields.lottery=o}})},(0,a.extend)(t.prototype,"headerItems",(function(t){var o,e,a=null==(o=this.composer.body)||null==(o=o.attrs)?void 0:o.discussion;(null!=(e=null==a?void 0:a.canStartLottery())?e:n().forum.canStartLottery())&&t.add("lottery",m("a",{className:"ComposerBody-lottery",onclick:this.addLottery.bind(this)},m("span",{className:p()("LotteryLabel",!this.composer.fields.lottery&&"none")},n().translator.trans("nodeloc-lottery.forum.composer_discussion."+(this.composer.fields.lottery?"edit":"add")+"_lottery"))),1)})),(0,a.extend)(t.prototype,"data",(function(t){this.composer.fields.lottery&&(t.lottery=this.composer.fields.lottery)}))};const U=flarum.core.compat["forum/components/CommentPost"];var j=t.n(U);const P=flarum.core.compat["common/Component"];var B=t.n(P);const E=flarum.core.compat["forum/components/LogInModal"];var q=t.n(E);const F=flarum.core.compat["common/helpers/avatar"];var T=t.n(F);const H=flarum.core.compat["common/helpers/username"];var R=t.n(H);const Y=flarum.core.compat["common/components/Link"];var z=t.n(Y);const J=flarum.core.compat["common/components/LoadingIndicator"];var $=t.n(J),G=function(t){function o(){return t.apply(this,arguments)||this}g(o,t);var e=o.prototype;return e.oninit=function(o){var e=this;t.prototype.oninit.call(this,o),this.loading=D()(!0),n().store.find("nodeloc/lottery",this.attrs.lottery.id(),{include:"votes,votes.user,votes.option"}).then((function(){return e.loading(!1)})).finally((function(){return m.redraw()}))},e.className=function(){return"Modal--medium VotesModal"},e.title=function(){return n().translator.trans("nodeloc-lottery.forum.votes_modal.title")},e.content=function(){return m("div",{className:"Modal-body"},this.loading()?m($(),null):this.attrs.lottery.options().map(this.optionContent.bind(this)))},e.optionContent=function(t){var o=(this.attrs.lottery.votes()||[]).filter((function(o){return t.id()===o.option().id()}));return m("div",{className:"VotesModal-option"},m("h2",null,t.answer()+":"),o.length?m("div",{className:"VotesModal-list"},o.map(this.voteContent.bind(this))):m("h4",null,n().translator.trans("nodeloc-lottery.forum.modal.no_voters")))},e.voteContent=function(t){var o=t.user(),e=o&&{href:n().route.user(o)};return m(z(),e,T()(o)," ",R()(o))},o}(x());const K=flarum.core.compat["common/components/Tooltip"];var Q=t.n(K);const W=flarum.core.compat["common/helpers/icon"];var X=t.n(W),Z=function(t){function o(){return t.apply(this,arguments)||this}g(o,t);var e=o.prototype;return e.oninit=function(o){t.prototype.oninit.call(this,o),this.lottery=this.attrs.lottery,this.options=this.lottery.options(),this.optionAnswers=this.options.map((function(t){return D()(t.answer())})),this.optionImageUrls=this.options.map((function(t){return D()(t.imageUrl())})),this.question=D()(this.lottery.question()),this.endDate=D()(this.formatDate(this.lottery.endDate())),this.publicLottery=D()(this.lottery.publicLottery()),this.allowMultipleVotes=D()(this.lottery.allowMultipleVotes()),this.hideVotes=D()(this.lottery.hideVotes()),this.allowChangeVote=D()(this.lottery.allowChangeVote()),this.maxVotes=D()(this.lottery.maxVotes()||0),this.endDate()&&dayjs(this.lottery.endDate()).isAfter(dayjs())&&(this.datepickerMinDate=this.formatDate(this.endDate()))},e.title=function(){return n().translator.trans("nodeloc-lottery.forum.modal.edit_title")},e.displayOptions=function(){var t=this;return this.options.map((function(o,e){return m("div",{className:"Form-group"},m("fieldset",{className:"Lottery-answer-input"},m("input",{className:"FormControl",type:"text",name:"answer"+(e+1),bidi:t.optionAnswers[e],placeholder:n().translator.trans("nodeloc-lottery.forum.modal.option_placeholder")+" #"+(e+1)}),n().forum.attribute("allowLotteryOptionImage")?m("input",{className:"FormControl",type:"text",name:"answerImage"+(e+1),bidi:t.optionImageUrls[e],placeholder:n().translator.trans("nodeloc-lottery.forum.modal.image_option_placeholder")+" #"+(e+1)}):null),e>=2?V().component({type:"button",className:"Button LotteryModal--button",icon:"fas fa-minus",onclick:e>=2?t.removeOption.bind(t,e):""}):"")}))},e.addOption=function(){var t=Math.max(n().forum.attribute("lotteryMaxOptions"),2);this.options.length<t?(this.options.push(n().store.createRecord("lottery_options")),this.optionAnswers.push(D()("")),this.optionImageUrls.push(D()(""))):alert(S()(n().translator.trans("nodeloc-lottery.forum.modal.max",{max:t})))},e.removeOption=function(t){this.options.splice(t,1),this.optionAnswers.splice(t,1),this.optionImageUrls.splice(t,1)},e.data=function(){var t=this,o=this.options.map((function(o,e){return o.data.attributes||(o.data.attributes={}),o.data.attributes.answer=t.optionAnswers[e](),o.data.attributes.imageUrl=t.optionImageUrls[e](),o.data}));return{question:this.question(),endDate:this.dateToTimestamp(this.endDate()),publicLottery:this.publicLottery(),hideVotes:this.hideVotes(),allowChangeVote:this.allowChangeVote(),allowMultipleVotes:this.allowMultipleVotes(),maxVotes:this.maxVotes(),options:o}},e.onsubmit=function(t){var o=this;if(t.preventDefault(),!this.loading)return this.loading=!0,this.lottery.save(this.data()).then((function(){o.hide(),m.redraw()})).catch((function(t){o.loaded(),o.onerror(t)}))},o}(k),tt=function(t){function o(){return t.apply(this,arguments)||this}g(o,t);var e=o.prototype;return e.oninit=function(o){var e,n;t.prototype.oninit.call(this,o),this.loadingOptions=!1,this.useSubmitUI=!(null!=(e=this.attrs.lottery)&&e.canChangeVote())&&(null==(n=this.attrs.lottery)?void 0:n.allowMultipleVotes()),this.pendingSubmit=!1,this.pendingOptions=null},e.oncreate=function(o){t.prototype.oncreate.call(this,o),this.preventClose=this.preventClose.bind(this),window.addEventListener("beforeunload",this.preventClose)},e.onremove=function(o){t.prototype.onremove.call(this,o),window.removeEventListener("beforeunload",this.preventClose)},e.view=function(){var t=this.attrs.lottery,o=t.options()||[],e=t.allowMultipleVotes()?t.maxVotes():1;0===e&&(e=o.length);var a=this.infoItems(e);return m("div",{className:"Post-lottery","data-id":t.id()},m("div",{className:"LotteryHeading"},m("h3",{className:"LotteryHeading-title"},t.question()),t.canSeeVoters()&&m(Q(),{text:n().translator.trans("nodeloc-lottery.forum.public_lottery")},m(V(),{className:"Button LotteryHeading-voters",onclick:this.showVoters.bind(this),icon:"fas fa-lottery"})),t.canEdit()&&m(Q(),{text:n().translator.trans("nodeloc-lottery.forum.moderation.edit")},m(V(),{className:"Button LotteryHeading-edit",onclick:n().modal.show.bind(n().modal,Z,{lottery:t}),icon:"fas fa-pen"})),t.canDelete()&&m(Q(),{text:n().translator.trans("nodeloc-lottery.forum.moderation.delete")},m(V(),{className:"Button LotteryHeading-delete",onclick:this.deleteLottery.bind(this),icon:"fas fa-trash"}))),m("div",null,m("div",{className:"LotteryOptions"},o.map(this.viewOption.bind(this))),m("div",{className:"Lottery-sticky"},!a.isEmpty()&&m("div",{className:"helpText LotteryInfoText"},a.toArray()),this.useSubmitUI&&this.pendingSubmit&&m(V(),{className:"Button Button--primary Lottery-submit",loading:this.loadingOptions,onclick:this.onsubmit.bind(this)},n().translator.trans("nodeloc-lottery.forum.lottery.submit_button")))))},e.infoItems=function(t){var o,e=new(C()),a=this.attrs.lottery,r=(null==(o=a.myVotes())?void 0:o.length)>0;return!n().session.user||a.canVote()||a.hasEnded()||e.add("no-permission",m("span",null,m("i",{className:"icon fas fa-times-circle fa-fw"}),n().translator.trans("nodeloc-lottery.forum.no_permission"))),a.endDate()&&e.add("end-date",m("span",null,m("i",{class:"icon fas fa-clock fa-fw"}),a.hasEnded()?n().translator.trans("nodeloc-lottery.forum.lottery_ended"):n().translator.trans("nodeloc-lottery.forum.days_remaining",{time:dayjs(a.endDate()).fromNow()}))),a.canVote()&&(e.add("max-votes",m("span",null,m("i",{className:"icon fas fa-lottery fa-fw"}),n().translator.trans("nodeloc-lottery.forum.max_votes_allowed",{max:t}))),a.canChangeVote()||e.add("cannot-change-vote",m("span",null,m("i",{className:"icon fas fa-"+(r?"times":"exclamation")+"-circle fa-fw"}),n().translator.trans("nodeloc-lottery.forum.lottery.cannot_change_vote")))),e},e.viewOption=function(t){var o,e,a,r=this.attrs.lottery,s=(null==(o=r.myVotes())?void 0:o.length)>0,i=r.voteCount(),l=this.pendingOptions?this.pendingOptions.has(t.id()):null==(e=r.myVotes())||null==e.some?void 0:e.some((function(o){return o.option()===t})),c=t.voteCount(),u=i>0?Math.round(c/i*100):0,d="number"==typeof c,h=this.loadingOptions||s&&!r.canChangeVote(),y=d?u:Number(l)/((null==(a=r.myVotes())?void 0:a.length)||1)*100,f=!n().session.user||!r.hasEnded()&&r.canVote()&&(!s||r.canChangeVote()),v=m("div",{className:"LotteryBar","data-selected":!!l,style:"--lottery-option-width: "+y+"%"},f&&m("label",{className:"LotteryAnswer-checkbox checkbox"},m("input",{onchange:this.changeVote.bind(this,t),type:"checkbox",checked:l,disabled:h}),m("span",{className:"checkmark"})),m("div",{className:"LotteryAnswer-text"},m("span",{className:"LotteryAnswer-text-answer"},t.answer()),l&&!f&&X()("fas fa-check-circle",{className:"LotteryAnswer-check"}),d&&m("span",{className:p()("LotteryPercent",100!==u&&"LotteryPercent--option")},u,"%")),t.imageUrl()?m("img",{className:"LotteryAnswer-image",src:t.imageUrl(),alt:t.answer()}):null);return m("div",{className:p()("LotteryOption",s&&"LotteryVoted",r.hasEnded()&&"LotteryEnded",t.imageUrl()&&"LotteryOption-hasImage"),"data-id":t.id()},d?m(Q(),{text:n().translator.trans("nodeloc-lottery.forum.tooltip.votes",{count:c}),onremove:this.hideOptionTooltip},v):v)},e.changeVote=function(t,o){var e,a;if(!n().session.user)return n().modal.show(q()),void(o.target.checked=!1);var r=this.pendingOptions||new Set(null==(e=(a=this.attrs.lottery.myVotes()).map)?void 0:e.call(a,(function(t){return t.option().id()}))),s=r.delete(t.id());return this.attrs.lottery.allowMultipleVotes()||r.clear(),s||r.add(t.id()),this.useSubmitUI?(this.pendingOptions=r.size?r:null,void(this.pendingSubmit=!!this.pendingOptions)):this.submit(r,null,(function(){return o.target.checked=s}))},e.onsubmit=function(){var t=this;return this.submit(this.pendingOptions,(function(){t.pendingOptions=null,t.pendingSubmit=!1}))},e.submit=function(t,o,e){var a=this;return this.loadingOptions=!0,m.redraw(),n().request({method:"PATCH",url:n().forum.attribute("apiUrl")+"/nodeloc/lottery/"+this.attrs.lottery.id()+"/votes",body:{data:{optionIds:Array.from(t)}}}).then((function(t){n().store.pushPayload(t),null==o||o()})).catch((function(t){null==e||e(t)})).finally((function(){a.loadingOptions=!1,m.redraw()}))},e.showVoters=function(){n().modal.show(G,{lottery:this.attrs.lottery,post:this.attrs.post})},e.deleteLottery=function(){confirm(n().translator.trans("nodeloc-lottery.forum.moderation.delete_confirm"))&&this.attrs.lottery.delete().then((function(){m.redraw.sync()}))},e.hideOptionTooltip=function(t){t.attrs.tooltipVisible=!1,t.state.updateVisibility()},e.preventClose=function(t){if(this.pendingOptions)return t.preventDefault(),!0},o}(B());const ot=flarum.core.compat["forum/components/DiscussionPage"];var et=t.n(ot);function nt(t,o){(null==o||o>t.length)&&(o=t.length);for(var e=0,n=new Array(o);e<o;e++)n[e]=t[e];return n}function at(){return at=Object.assign?Object.assign.bind():function(t){for(var o=1;o<arguments.length;o++){var e=arguments[o];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])}return t},at.apply(this,arguments)}const rt=flarum.core.compat["forum/utils/PostControls"];var st=t.n(rt),it={CreateLotteryModal:k,PostLottery:tt,EditLotteryModal:Z,ListVotersModal:G};const lt=flarum.core.compat["common/Model"];var mt=t.n(lt),ct=function(t){function o(){for(var o,e=arguments.length,n=new Array(e),a=0;a<e;a++)n[a]=arguments[a];return(o=t.call.apply(t,[this].concat(n))||this).question=mt().attribute("question"),o.hasEnded=mt().attribute("hasEnded"),o.endDate=mt().attribute("endDate"),o.publicLottery=mt().attribute("publicLottery"),o.hideVotes=mt().attribute("hideVotes"),o.allowChangeVote=mt().attribute("allowChangeVote"),o.allowMultipleVotes=mt().attribute("allowMultipleVotes"),o.maxVotes=mt().attribute("maxVotes"),o.voteCount=mt().attribute("voteCount"),o.canVote=mt().attribute("canVote"),o.canEdit=mt().attribute("canEdit"),o.canDelete=mt().attribute("canDelete"),o.canSeeVoters=mt().attribute("canSeeVoters"),o.canChangeVote=mt().attribute("canChangeVote"),o.options=mt().hasMany("options"),o.votes=mt().hasMany("votes"),o.myVotes=mt().hasMany("myVotes"),o}return g(o,t),o.prototype.apiEndpoint=function(){return"/nodeloc/lottery"+(this.exists?"/"+this.data.id:"")},o}(mt()),ut=function(t){function o(){for(var o,e=arguments.length,n=new Array(e),a=0;a<e;a++)n[a]=arguments[a];return(o=t.call.apply(t,[this].concat(n))||this).answer=mt().attribute("answer"),o.imageUrl=mt().attribute("imageUrl"),o.voteCount=mt().attribute("voteCount"),o.lottery=mt().hasOne("lottery"),o.votes=mt().hasMany("votes"),o}return g(o,t),o.prototype.apiEndpoint=function(){return"/nodeloc/lottery/answers"+(this.exists?"/"+this.data.id:"")},o}(mt()),dt=function(t){function o(){for(var o,e=arguments.length,n=new Array(e),a=0;a<e;a++)n[a]=arguments[a];return(o=t.call.apply(t,[this].concat(n))||this).lottery=mt().hasOne("lottery"),o.option=mt().hasOne("option"),o.user=mt().hasOne("user"),o.lotteryId=mt().attribute("lotteryId"),o.optionId=mt().attribute("optionId"),o}return g(o,t),o.prototype.apiEndpoint=function(){return"/nodeloc/lottery/"+this.lotteryId()+"/vote"},o}(mt()),pt={Poll:ct,PollOption:ut,PollVote:dt};const ht=flarum.core.compat["common/extenders"];var yt=t.n(ht);const ft=flarum.core.compat["common/models/Post"];var vt=t.n(ft);const bt=flarum.core.compat["common/models/Forum"];var gt=t.n(bt);const wt=[(new(yt().Store)).add("lottery",ct).add("lottery_options",ut).add("lottery_votes",dt),new(yt().Model)(vt()).hasMany("lottery").attribute("canStartLottery"),new(yt().Model)(gt()).attribute("canStartLottery"),new(yt().Model)(u()).attribute("hasLottery").attribute("canStartLottery")];n().initializers.add("nodeloc/lottery",(function(){var t;(0,a.extend)(l().prototype,"requestParams",(function(t){t.include.push("lottery")})),(0,a.extend)(u().prototype,"badges",(function(t){this.hasLottery()&&t.add("lottery",s().component({type:"lottery",label:n().translator.trans("nodeloc-lottery.forum.tooltip.badge"),icon:"fas fa-gift"}),5)})),A(y()),A(v()),(0,a.extend)(j().prototype,"content",(function(t){var o=this.attrs.post;if((!o.isHidden()||this.revealContent)&&o.lottery())for(var e,n=function(t,o){var e="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(e)return(e=e.call(t)).next.bind(e);if(Array.isArray(t)||(e=function(t,o){if(t){if("string"==typeof t)return nt(t,o);var e=Object.prototype.toString.call(t).slice(8,-1);return"Object"===e&&t.constructor&&(e=t.constructor.name),"Map"===e||"Set"===e?Array.from(t):"Arguments"===e||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e)?nt(t,o):void 0}}(t))||o&&t&&"number"==typeof t.length){e&&(t=e);var n=0;return function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(o.lottery());!(e=n()).done;){var a=e.value;a&&t.push(m(tt,{post:o,lottery:a}))}})),(0,a.extend)(j().prototype,"oninit",(function(){var t=this;this.subtree.check((function(){var o=t.attrs.post.lottery(),e=null==o||null==o.map?void 0:o.map((function(t){var o,e,n,a,r;return t&&[null==(o=t.data)?void 0:o.attributes,null==(e=(n=t.options()).map)?void 0:e.call(n,(function(t){var o;return null==t||null==(o=t.data)?void 0:o.attributes})),null==(a=(r=t.myVotes()).map)?void 0:a.call(r,(function(t){var o;return null==(o=t.option())?void 0:o.id()}))]}));return JSON.stringify(e)}))})),(0,a.extend)(et().prototype,"oncreate",(function(){n().pusher&&n().pusher.then((function(t){t.channels.main.bind("updatedLotteryOptions",(function(t){var o=n().store.getById("lottery",t.lotteryId);o&&o.pushAttributes({voteCount:t.lotteryVoteCount});var e=t.options;for(var a in e){var r=n().store.getById("lottery_options",a);r&&void 0!==r.voteCount()&&r.pushAttributes({voteCount:e[a]})}m.redraw()}))}))})),(0,a.extend)(et().prototype,"onremove",(function(){n().pusher&&n().pusher.then((function(t){t.channels.main.unbind("updatedLotteryOptions")}))})),t=function(t){return n().modal.show(k,{onsubmit:function(o){return n().store.createRecord("lottery").save(at({},o,{relationships:{post:t}}),{data:{include:"options,myVotes,myVotes.option"}}).then((function(o){var e;return null==(e=t.rawRelationship("lottery"))||null==e.push||e.push({type:"lottery",id:o.id()}),o}))}})},(0,a.extend)(st(),"moderationControls",(function(o,e){!e.isHidden()&&e.canStartLottery()&&o.add("addLottery",m(V(),{icon:"fas fa-lottery",onclick:t.bind(this,e)},n().translator.trans("nodeloc-lottery.forum.moderation.add")))}))}))})(),module.exports=o})();
//# sourceMappingURL=forum.js.map