(()=>{var t={n:o=>{var e=o&&o.__esModule?()=>o.default:()=>o;return t.d(e,{a:e}),e},d:(o,e)=>{for(var a in e)t.o(e,a)&&!t.o(o,a)&&Object.defineProperty(o,a,{enumerable:!0,get:e[a]})},o:(t,o)=>Object.prototype.hasOwnProperty.call(t,o),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},o={};(()=>{"use strict";t.r(o),t.d(o,{components:()=>st,extend:()=>_t,models:()=>pt});const e=flarum.core.compat["forum/app"];var a=t.n(e);const r=flarum.core.compat["common/extend"],n=flarum.core.compat["common/components/Badge"];var s=t.n(n);const i=flarum.core.compat["forum/components/DiscussionList"];var l=t.n(i);const c=flarum.core.compat["common/models/Discussion"];var u=t.n(c);const p=flarum.core.compat["common/utils/classList"];var d=t.n(p);const h=flarum.core.compat["forum/components/DiscussionComposer"];var f=t.n(h);const y=flarum.core.compat["forum/components/ReplyComposer"];var v=t.n(y);function b(t,o){return b=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,o){return t.__proto__=o,t},b(t,o)}function _(t,o){t.prototype=Object.create(o.prototype),t.prototype.constructor=t,b(t,o)}const g=flarum.core.compat["common/components/Button"];var w=t.n(g);const M=flarum.core.compat["common/components/Modal"];var x=t.n(M);flarum.core.compat["common/components/Switch"];const D=flarum.core.compat["common/utils/ItemList"];var N=t.n(D);const L=flarum.core.compat["common/utils/Stream"];var S=t.n(L);const O=flarum.core.compat["common/utils/extractText"];var C=t.n(O);const B=flarum.core.compat["common/components/Select"];var E=t.n(B),I=function(t){function o(){for(var o,e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];return(o=t.call.apply(t,[this].concat(r))||this).select_options={discussions_started:a().translator.trans("nodeloc-lottery.forum.modal.discussions_started"),posts_made:a().translator.trans("nodeloc-lottery.forum.modal.posts_made"),money:a().translator.trans("nodeloc-lottery.forum.modal.money"),lotteries_made:a().translator.trans("nodeloc-lottery.forum.modal.lotteries_made")},o}_(o,t);var e=o.prototype;return e.oninit=function(o){var e=this;t.prototype.oninit.call(this,o),this.operator_type=[S()("discussions_started")],this.operator=[S()("1")],this.operator_value=[S()("1")],this.prizes=S()(""),this.price=S()(""),this.amount=S()(""),this.endDate=S()(),this.allowCancleEnter=S()(!0),this.min_participants=S()(0),this.max_participants=S()(999999),this.datepickerMinDate=this.formatDate(void 0);var a=this.attrs.lottery;a&&Array.isArray(a.options)&&(this.operator_type=[],this.operator=[],this.operator_value=[],a.options.forEach((function(t){e.operator_type.push(S()(t.operator_type)),e.operator.push(S()(t.operator)),e.operator_value.push(S()(t.operator_value))})),this.prizes(a.prizes),this.price(a.price),this.amount(a.amount),this.allowCancleEnter(a.allowCancleEnter),this.min_participants(a.min_participants||0),this.max_participants(a.max_participants||999999),this.endDate(this.formatDate(a.endDate)),this.endDate()&&dayjs(a.endDate).isAfter(dayjs())&&(this.datepickerMinDate=this.formatDate(a.endDate)))},e.title=function(){return a().translator.trans("nodeloc-lottery.forum.modal.add_title")},e.className=function(){return"LotteryDiscussionModal Modal--medium"},e.content=function(){return[m("div",{className:"Modal-body"},m("div",{className:"LotteryDiscussionModal-form"},this.fields().toArray()))]},e.fields=function(){var t=new(N());return t.add("prizes",m("div",{className:"Form-group"},m("label",{className:"label"},a().translator.trans("nodeloc-lottery.forum.modal.lottery_placeholder")),m("input",{type:"text",name:"prizes",className:"FormControl",bidi:this.prizes})),100),t.add("price",m("div",{className:"Form-group"},m("label",{className:"label"},a().translator.trans("nodeloc-lottery.forum.modal.price")),m("input",{type:"number",min:"1",name:"price",className:"FormControl",bidi:this.price})),100),t.add("amount",m("div",{className:"Form-group"},m("label",{className:"label"},a().translator.trans("nodeloc-lottery.forum.modal.amount")),m("input",{type:"number",min:"1",name:"amount",className:"FormControl",bidi:this.amount})),100),t.add("conditions",m("div",{className:"LotteryModal--answers Form-group"},m("label",{className:"label LotteryModal--answers-title"},m("span",null,a().translator.trans("nodeloc-lottery.forum.modal.options_label")),w().component({className:"Button LotteryModal--button small",icon:"fas fa-plus",onclick:this.addOption.bind(this)})),this.displayOptions()),80),t.add("date",m("div",{className:"Form-group"},m("label",{className:"label"},a().translator.trans("nodeloc-lottery.forum.modal.date_placeholder")),m("div",{className:"LotteryModal--date"},m("input",{className:"FormControl",type:"datetime-local",name:"date",bidi:this.endDate,min:this.datepickerMinDate,max:this.formatDate("2038")}),w().component({className:"Button LotteryModal--button",icon:"fas fa-times",onclick:this.endDate.bind(this,null)})),this.endDate()&&m("p",{className:"helpText"},m("i",{class:"icon fas fa-clock"})," ",dayjs(this.endDate()).isBefore(dayjs())?a().translator.trans("nodeloc-lottery.forum.lottery_ended"):a().translator.trans("nodeloc-lottery.forum.days_remaining",{time:dayjs(this.endDate()).fromNow()}))),40),t.add("min-participants",m("div",{className:"Form-group MinMaxSelector"},m("label",{className:"label"},a().translator.trans("nodeloc-lottery.forum.modal.participants_help")),m("div",{class:"MinMaxSelector--inputs"},m("input",{type:"number",min:"0",name:"min_participants",className:"FormControl",bidi:this.min_participants}),m("button",{class:"Button hasIcon",type:"button"},m("i",{"aria-hidden":"true",class:"icon fas fa-less-than-equal Button-icon"}),m("span",{class:"Button-label"})),m("input",{class:"FormControl MinMaxSelector--placeholder",disabled:!0,placeholder:a().translator.trans("nodeloc-lottery.forum.modal.participants_label")}),m("button",{class:"Button hasIcon",type:"button"},m("i",{"aria-hidden":"true",class:"icon fas fa-less-than-equal Button-icon"}),m("span",{class:"Button-label"})),m("input",{type:"number",max:"999999",name:"max_participants",className:"FormControl",bidi:this.max_participants}))),15),t.add("submit",m("div",{className:"Form-group"},w().component({type:"submit",className:"Button Button--primary LotteryModal-SubmitButton",loading:this.loading},a().translator.trans("nodeloc-lottery.forum.modal.submit"))),-10),t},e.displayOptions=function(){var t=this;return Object.keys(this.operator_value).map((function(o,e){return m("div",{className:"Form-group MinMaxSelector"},m("fieldset",{className:"MinMaxSelector--inputs"},m("span",{class:"Select"},E().component({options:t.select_options,value:t.operator_type[e](),onchange:function(o){t.operator_type[e](o)}}),m("i",{"aria-hidden":"true",class:"icon fas fa-sort Select-caret"})),m("button",{class:"Button hasIcon",type:"button",onclick:function(){return t.operator[e](0===t.operator[e]()?1:0)}},0===t.operator[e]()?m("i",{"aria-hidden":"true",class:"icon fas fa-less-than-equal Button-icon"}):m("i",{"aria-hidden":"true",class:"icon fas fa-greater-than-equal Button-icon"}),m("span",{class:"Button-label"})),m("input",{className:"FormControl",type:"number",name:"operatorvalue"+(e+1),bidi:t.operator_value[e],placeholder:a().translator.trans("nodeloc-lottery.forum.modal.option_placeholder")+" #"+(e+1)})),e>=2?w().component({type:"button",className:"Button Button--warning LotteryModal--button",icon:"fas fa-minus",onclick:e>=1?t.removeOption.bind(t,e):""}):"")}))},e.addOption=function(){this.operator_value.length<5?(this.operator_type.push(S()("money")),this.operator.push(S()("1")),this.operator_value.push(S()("1"))):alert(C()(a().translator.trans("nodeloc-lottery.forum.modal.max",{max:5})))},e.removeOption=function(t){this.operator_type.splice(t,1),this.operator.splice(t,1),this.operator_value.splice(t,1)},e.data=function(){var t=this,o={prizes:this.prizes(),price:this.price(),amount:this.amount(),endDate:this.dateToTimestamp(this.endDate()),allowCancelEnter:this.allowCancleEnter(),min_participants:this.min_participants(),max_participants:this.max_participants(),options:[]};return this.operator_value.forEach((function(e,a){e()&&o.options.push({operator_type:t.operator_type[a](),operator:t.operator[a](),operator_value:e()})})),""===this.prizes()?(alert(a().translator.trans("nodeloc-lottery.forum.modal.include_prizes")),null):""===this.price()?(alert(a().translator.trans("nodeloc-lottery.forum.modal.include_price")),null):""===this.amount()?(alert(a().translator.trans("nodeloc-lottery.forum.modal.include_amount")),null):o.options.length<1?(alert(a().translator.trans("nodeloc-lottery.forum.modal.min")),null):""===this.endDate()?(alert(a().translator.trans("nodeloc-lottery.forum.modal.include_end_date")),null):o},e.onsubmit=function(t){var o=this;t.preventDefault();var e=this.data();if(null!==e){var r=this.attrs.onsubmit(e);r instanceof Promise?(this.loading=!0,r.then(this.hide.bind(this),(function(t){console.error(t),o.onerror(t),o.loaded()}))):a().modal.close()}},e.formatDate=function(t,o){void 0===o&&(o=!1);var e=dayjs(t);return!1!==t&&e.isValid()?e.format("YYYY-MM-DDTHH:mm"):!1!==o?this.formatDate(o):null},e.dateToTimestamp=function(t){var o=dayjs(t);return!(!t||!o.isValid())&&o.format()},o}(x()),j=function(t){t.prototype.addLottery=function(){var t=this;a().modal.show(I,{lottery:this.composer.fields.lottery,onsubmit:function(o){return t.composer.fields.lottery=o}})},(0,r.extend)(t.prototype,"headerItems",(function(t){var o,e,r=null==(o=this.composer.body)||null==(o=o.attrs)?void 0:o.discussion;(null!=(e=null==r?void 0:r.canStartLottery())?e:a().forum.canStartLottery())&&t.add("lottery",m("a",{className:"ComposerBody-lottery",onclick:this.addLottery.bind(this)},m("span",{className:d()("LotteryLabel",!this.composer.fields.lottery&&"none")},a().translator.trans("nodeloc-lottery.forum.composer_discussion."+(this.composer.fields.lottery?"edit":"add")+"_lottery"))),1)})),(0,r.extend)(t.prototype,"data",(function(t){this.composer.fields.lottery&&(t.lottery=this.composer.fields.lottery)}))};const k=flarum.core.compat["forum/components/CommentPost"];var P=t.n(k);const T=flarum.core.compat["common/Component"];var z=t.n(T);const A=flarum.core.compat["forum/components/LogInModal"];var F=t.n(A);const H=flarum.core.compat["common/helpers/avatar"];var q=t.n(H);const V=flarum.core.compat["common/helpers/username"];var U=t.n(V);const Y=flarum.core.compat["common/components/Link"];var R=t.n(Y);const $=flarum.core.compat["common/components/LoadingIndicator"];var G=t.n($),J=function(t){function o(){return t.apply(this,arguments)||this}_(o,t);var e=o.prototype;return e.oninit=function(o){var e=this;t.prototype.oninit.call(this,o),this.loading=S()(!0),a().store.find("nodeloc/lottery",this.attrs.lottery.id(),{include:"participants,participants.user,participants.status"}).then((function(){return e.loading(!1)})).finally((function(){return m.redraw()}))},e.className=function(){return"Modal--medium ParticipantsModal"},e.title=function(){return a().translator.trans("nodeloc-lottery.forum.participants_modal.title"+(this.attrs.lottery.hasEnded()?"_winners":""))},e.content=function(){return m("div",{className:"Modal-body"},this.loading()?m(G(),null):this.optionContent())},e.optionContent=function(){var t=this.attrs.lottery.participants();return m("div",{className:"VotesModal-option"},t.length?m("div",{className:"VotesModal-list"},t.map(this.participantsContent.bind(this))):m("h4",null,a().translator.trans("nodeloc-lottery.forum.modal.no_participants")))},e.participantsContent=function(t){var o=t.user();if(this.attrs.lottery.hasEnded()&&1!==t.status())return null;var e=o&&{href:a().route.user(o)};return m(R(),e,q()(o)," ",U()(o))},o}(x());const K=flarum.core.compat["common/components/Tooltip"];var Q=t.n(K);flarum.core.compat["common/helpers/icon"];var W=function(t){function o(){return t.apply(this,arguments)||this}_(o,t);var e=o.prototype;return e.oninit=function(o){t.prototype.oninit.call(this,o),this.lottery=this.attrs.lottery,this.options=this.lottery.options(),this.operator_type=this.options.map((function(t){return S()(t.operator_type())})),this.operator=this.options.map((function(t){return S()(t.operator())})),this.operator_value=this.options.map((function(t){return S()(t.operator_value())})),this.prizes=S()(this.lottery.prizes()),this.price=S()(this.lottery.price()),this.amount=S()(this.lottery.amount()),this.endDate=S()(this.formatDate(this.lottery.endDate())),this.min_participants=S()(this.lottery.min_participants()||0),this.max_participants=S()(this.lottery.max_participants()||999999),this.endDate()&&dayjs(this.lottery.endDate()).isAfter(dayjs())&&(this.datepickerMinDate=this.formatDate(this.endDate()))},e.title=function(){return a().translator.trans("nodeloc-lottery.forum.modal.edit_title")},e.displayOptions=function(){var t=this;return this.options.map((function(o,e){return m("div",{className:"Form-group MinMaxSelector"},m("fieldset",{className:"MinMaxSelector--inputs"},m("span",{class:"Select"},E().component({options:t.select_options,value:t.operator_type[e](),onchange:function(o){t.operator_type[e](o)}}),m("i",{"aria-hidden":"true",class:"icon fas fa-sort Select-caret"})),m("button",{class:"Button hasIcon",type:"button",onclick:function(){return t.operator[e](0===t.operator[e]()?1:0)}},0===t.operator[e]()?m("i",{"aria-hidden":"true",class:"icon fas fa-less-than-equal Button-icon"}):m("i",{"aria-hidden":"true",class:"icon fas fa-greater-than-equal Button-icon"}),m("span",{class:"Button-label"})),m("input",{className:"FormControl",type:"number",name:"operatorvalue"+(e+1),bidi:t.operator_value[e],placeholder:a().translator.trans("nodeloc-lottery.forum.modal.option_placeholder")+" #"+(e+1)})),e>=2?w().component({type:"button",className:"Button Button--warning LotteryModal--button",icon:"fas fa-minus",onclick:e>=1?t.removeOption.bind(t,e):""}):"")}))},e.addOption=function(){this.operator_value.length<5?(this.operator_type.push(S()("")),this.operator.push(S()("")),this.operator_value.push(S()("")),this.displayOptions()):alert(C()(a().translator.trans("nodeloc-lottery.forum.modal.max",{max:5})))},e.removeOption=function(t){this.operator_type.splice(t,1),this.operator.splice(t,1),this.operator_value.splice(t,1)},e.data=function(){var t=this,o=this.options.map((function(o,e){return o.data.attributes||(o.data.attributes={}),o.data.attributes.operator_type=t.operator_type[e](),o.data.attributes.operator=t.operator[e](),o.data.attributes.operator_value=t.operator_value[e](),o.data}));return{prizes:this.prizes(),price:this.price(),amount:this.amount(),endDate:this.dateToTimestamp(this.endDate()),min_participants:this.min_participants(),max_participants:this.max_participants(),options:o}},e.onsubmit=function(t){var o=this;if(t.preventDefault(),!this.loading)return this.loading=!0,this.lottery.save(this.data()).then((function(){o.hide(),m.redraw()})).catch((function(t){o.loaded(),o.onerror(t)}))},o}(I),X=function(t){function o(){return t.apply(this,arguments)||this}_(o,t);var e=o.prototype;return e.oninit=function(t){t.state.days=S()(),t.state.hours=S()(),t.state.minutes=S()(),t.state.seconds=S()()},e.oncreate=function(t){var o=t.attrs.endDate;!function(t,e){var r=document.getElementById("clockdiv"),n=r.querySelector(".days"),s=r.querySelector(".hours"),i=r.querySelector(".minutes"),l=r.querySelector(".seconds");function c(){var t=function(t){var o=Date.parse(t)-Date.parse(new Date),e=Math.floor(o/1e3%60),a=Math.floor(o/1e3/60%60),r=Math.floor(o/36e5%24);return{total:o,days:Math.floor(o/864e5),hours:r,minutes:a,seconds:e}}(o);if(n.innerHTML=t.days,s.innerHTML=("0"+t.hours).slice(-2),i.innerHTML=("0"+t.minutes).slice(-2),l.innerHTML=("0"+t.seconds).slice(-2),t.total<0){if(clearInterval(m),document.getElementById("titleEvent")){var e=document.getElementById("titleEvent");e.parentNode.removeChild(e)}var r=a().translator.trans("nodeloc-lottery.forum.endDateText");document.getElementById("clockdiv").innerHTML='<h1 class="letterpress">'+r+"</h1>"}}c();var m=setInterval((function(){return c()}),1e3)}()},e.view=function(t){var o=a().translator.trans("nodeloc-lottery.forum.days"),e=a().translator.trans("nodeloc-lottery.forum.hours"),r=a().translator.trans("nodeloc-lottery.forum.minutes"),n=a().translator.trans("nodeloc-lottery.forum.seconds"),s=a().forum.attribute("event_title")||a().translator.trans("nodeloc-lottery.forum.hurry_up"),i=a().forum.attribute("fontawesome_events_icon")||"fas fa-gift";return m("div",{class:"countdown-container"},m("h2",{class:"event-text",id:"titleEvent"},m("i",{class:i+" fontawicon"}),s),m("div",{id:"clockdiv"},m("div",{class:"cntdwn-widget"},m("span",{class:"days"},t.state.days()),m("div",{class:"smalltext"},o)),m("div",{class:"cntdwn-widget"},m("span",{class:"hours"},t.state.hours()),m("div",{class:"smalltext"},e)),m("div",{class:"cntdwn-widget"},m("span",{class:"minutes"},t.state.minutes()),m("div",{class:"smalltext"},r)),m("div",{class:"cntdwn-widget"},m("span",{class:"seconds"},t.state.seconds()),m("div",{class:"smalltext"},n))))},o}(z()),Z=function(t){function o(){for(var o,e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];return(o=t.call.apply(t,[this].concat(r))||this).select_options={discussions_started:a().translator.trans("nodeloc-lottery.forum.modal.discussions_started"),posts_made:a().translator.trans("nodeloc-lottery.forum.modal.posts_made"),money:a().translator.trans("nodeloc-lottery.forum.modal.money"),lotteries_made:a().translator.trans("nodeloc-lottery.forum.modal.lotteries_made")},o}_(o,t);var e=o.prototype;return e.oninit=function(o){var e;t.prototype.oninit.call(this,o),this.loadingOptions=!1,this.useSubmitUI=!(null!=(e=this.attrs.lottery)&&e.canCancelEnter())&&this.attrs.lottery,this.pendingSubmit=!1},e.oncreate=function(o){t.prototype.oncreate.call(this,o)},e.onremove=function(o){t.prototype.onremove.call(this,o)},e.view=function(){var t,o=this.attrs.lottery,e=o.options()||[],r=this.infoItems(),n=dayjs(o.endDate()),s=(null==(t=o.lottery_participants())?void 0:t.length)>0;return m("div",{className:"Post-lottery","data-id":o.id()},m("div",{className:"LotteryHeading"},m("h3",{className:"LotteryHeading-title"},o.prizes()),m(Q(),{text:a().translator.trans("nodeloc-lottery.forum.public_lottery")},m(w(),{className:"Button LotteryHeading-voters",onclick:this.showparticipants.bind(this),icon:"fas fa-user"})),o.canEdit()&&m(Q(),{text:a().translator.trans("nodeloc-lottery.forum.moderation.edit")},m(w(),{className:"Button LotteryHeading-edit",onclick:a().modal.show.bind(a().modal,W,{lottery:o}),icon:"fas fa-pen"})),o.canDelete()&&m(Q(),{text:a().translator.trans("nodeloc-lottery.forum.moderation.delete")},m(w(),{className:"Button LotteryHeading-delete",onclick:this.deleteLottery.bind(this),icon:"fas fa-trash"}))),m("div",null,m("div",{className:"PrizeInfo"},m("div",{className:"PrizeDetails"},m("div",null,a().translator.trans("nodeloc-lottery.forum.modal.lottery_placeholder"),": ",o.prizes()),m("div",null,a().translator.trans("nodeloc-lottery.forum.modal.amount"),": ",o.amount()),m("div",null,a().translator.trans("nodeloc-lottery.forum.modal.price"),": ",o.price()),0!==o.min_participants()&&m("div",null,a().translator.trans("nodeloc-lottery.forum.modal.min_participants"),": ",o.min_participants()),o.max_participants()<9999&&m("div",null,a().translator.trans("nodeloc-lottery.forum.modal.max_participants"),": ",o.max_participants())),m(X,{endDate:n})),m("div",{className:"LotteryOptions"},o.min_participants()>0&&o.enterCount()&&m(".arrow",[m(".arrow-status",{style:{width:o.enterCount()/o.min_participants()*100+"%"}},[m("span.arrow-pointer","已有"+o.enterCount()+"人 / 最低"+o.min_participants()+"人")])]),m("h2",{class:"event-text"},m("i",{class:"fas fa-info-circle fontawicon"})," ",a().translator.trans("nodeloc-lottery.forum.modal.options_label")),m("ul",null,e.map(this.viewOption.bind(this)))),m("div",{className:"Lottery-sticky"},!r.isEmpty()&&m("div",{className:"helpText LotteryInfoText"},r.toArray()),this.useSubmitUI&&!s&&m(w(),{className:"Button Button--primary Lottery-submit",loading:this.loadingOptions,onclick:this.onsubmit.bind(this)},a().translator.trans("nodeloc-lottery.forum.lottery.submit_button")))))},e.infoItems=function(){var t,o=new(N()),e=this.attrs.lottery,r=(null==(t=e.lottery_participants())?void 0:t.length)>0;return!a().session.user||e.canEnter()||e.hasEnded()||o.add("no-permission",m("span",null,m("i",{className:"icon fas fa-times-circle fa-fw"}),a().translator.trans("nodeloc-lottery.forum.no_permission"))),e.endDate()&&o.add("end-date",m("span",null,m("i",{class:"icon fas fa-clock fa-fw"}),e.hasEnded()?a().translator.trans("nodeloc-lottery.forum.lottery_ended"):a().translator.trans("nodeloc-lottery.forum.days_remaining",{time:dayjs(e.endDate()).fromNow()}))),r&&o.add("had-enter",m("span",null,m("i",{class:"icon fas fa-check-double fa-fw"}),a().translator.trans("nodeloc-lottery.forum.had_enter"))),o},e.viewOption=function(t){var o=this.select_options[t.operator_type()]||"",e=0===t.operator()?"<":">";return m("li",null,o,e,t.operator_value())},e.onsubmit=function(){var t=this;if(a().session.user)return this.submit((function(){t.pendingSubmit=!1}));a().modal.show(F())},e.submit=function(t,o,e){var r=this;return this.loadingOptions=!0,m.redraw(),a().request({method:"PATCH",url:a().forum.attribute("apiUrl")+"/nodeloc/lottery/"+this.attrs.lottery.id()+"/enter"}).then((function(t){a().store.pushPayload(t),null==o||o()})).catch((function(t){null==e||e(t)})).finally((function(){r.loadingOptions=!1,m.redraw()}))},e.showparticipants=function(){a().modal.show(J,{lottery:this.attrs.lottery,post:this.attrs.post})},e.deleteLottery=function(){confirm(a().translator.trans("nodeloc-lottery.forum.moderation.delete_confirm"))&&this.attrs.lottery.delete().then((function(){m.redraw.sync()}))},o}(z());const tt=flarum.core.compat["forum/components/DiscussionPage"];var ot=t.n(tt);function et(t,o){(null==o||o>t.length)&&(o=t.length);for(var e=0,a=new Array(o);e<o;e++)a[e]=t[e];return a}function at(){return at=Object.assign?Object.assign.bind():function(t){for(var o=1;o<arguments.length;o++){var e=arguments[o];for(var a in e)Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a])}return t},at.apply(this,arguments)}const rt=flarum.core.compat["forum/utils/PostControls"];var nt=t.n(rt),st={CreateLotteryModal:I,PostLottery:Z,EditLotteryModal:W,ListVotersModal:J};const it=flarum.core.compat["common/Model"];var lt=t.n(it),ct=function(t){function o(){for(var o,e=arguments.length,a=new Array(e),r=0;r<e;r++)a[r]=arguments[r];return(o=t.call.apply(t,[this].concat(a))||this).prizes=lt().attribute("prizes"),o.hasEnded=lt().attribute("hasEnded"),o.endDate=lt().attribute("endDate"),o.price=lt().attribute("price"),o.amount=lt().attribute("amount"),o.min_participants=lt().attribute("min_participants"),o.max_participants=lt().attribute("max_participants"),o.enterCount=lt().attribute("enter_count"),o.status=lt().attribute("status"),o.canEnter=lt().attribute("canEnter"),o.canEdit=lt().attribute("canEdit"),o.canDelete=lt().attribute("canDelete"),o.canSeeParticipants=lt().attribute("canSeeParticipants"),o.canCancelEnter=lt().attribute("can_cancel_enter"),o.options=lt().hasMany("options"),o.participants=lt().hasMany("participants"),o.lottery_participants=lt().hasMany("lottery_participants"),o}return _(o,t),o.prototype.apiEndpoint=function(){return"/nodeloc/lottery"+(this.exists?"/"+this.data.id:"")},o}(lt()),mt=function(t){function o(){for(var o,e=arguments.length,a=new Array(e),r=0;r<e;r++)a[r]=arguments[r];return(o=t.call.apply(t,[this].concat(a))||this).operator_type=lt().attribute("operator_type"),o.operator=lt().attribute("operator"),o.operator_value=lt().attribute("operator_value"),o.lottery=lt().hasOne("lottery"),o}return _(o,t),o.prototype.apiEndpoint=function(){return"/nodeloc/lottery/operator"+(this.exists?"/"+this.data.id:"")},o}(lt()),ut=function(t){function o(){for(var o,e=arguments.length,a=new Array(e),r=0;r<e;r++)a[r]=arguments[r];return(o=t.call.apply(t,[this].concat(a))||this).lottery=lt().hasOne("lottery"),o.user=lt().hasOne("user"),o.status=lt().attribute("status"),o.lotteryId=lt().attribute("lotteryId"),o}return _(o,t),o.prototype.apiEndpoint=function(){return"/nodeloc/lottery/"+this.lotteryId()+"/enter"},o}(lt()),pt={Lottery:ct,LotteryOption:mt,LotteryParticipants:ut};const dt=flarum.core.compat["common/extenders"];var ht=t.n(dt);const ft=flarum.core.compat["common/models/Post"];var yt=t.n(ft);const vt=flarum.core.compat["common/models/Forum"];var bt=t.n(vt);const _t=[(new(ht().Store)).add("lottery",ct).add("lottery_options",mt).add("lottery_participants",ut),new(ht().Model)(yt()).hasMany("lottery").attribute("canStartLottery"),new(ht().Model)(bt()).attribute("canStartLottery"),new(ht().Model)(u()).attribute("hasLottery").attribute("canStartLottery")];a().initializers.add("nodeloc/lottery",(function(){var t;(0,r.extend)(l().prototype,"requestParams",(function(t){t.include.push("lottery")})),(0,r.extend)(u().prototype,"badges",(function(t){this.hasLottery()&&t.add("lottery",s().component({type:"lottery",label:a().translator.trans("nodeloc-lottery.forum.tooltip.badge"),icon:"fas fa-gift"}),5)})),j(f()),j(v()),(0,r.extend)(P().prototype,"content",(function(t){var o=this.attrs.post;if((!o.isHidden()||this.revealContent)&&o.lottery())for(var e,a=function(t,o){var e="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(e)return(e=e.call(t)).next.bind(e);if(Array.isArray(t)||(e=function(t,o){if(t){if("string"==typeof t)return et(t,o);var e=Object.prototype.toString.call(t).slice(8,-1);return"Object"===e&&t.constructor&&(e=t.constructor.name),"Map"===e||"Set"===e?Array.from(t):"Arguments"===e||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e)?et(t,o):void 0}}(t))||o&&t&&"number"==typeof t.length){e&&(t=e);var a=0;return function(){return a>=t.length?{done:!0}:{done:!1,value:t[a++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(o.lottery());!(e=a()).done;){var r=e.value;r&&t.push(m(Z,{post:o,lottery:r}))}})),(0,r.extend)(ot().prototype,"oncreate",(function(){a().pusher&&a().pusher.then((function(t){t.channels.main.bind("updatedLotteryOptions",(function(t){var o=a().store.getById("lottery",t.lotteryId);o&&o.pushAttributes({voteCount:t.lotteryVoteCount});var e=t.options;for(var r in e){var n=a().store.getById("lottery_options",r);n&&void 0!==n.voteCount()&&n.pushAttributes({voteCount:e[r]})}m.redraw()}))}))})),(0,r.extend)(ot().prototype,"onremove",(function(){a().pusher&&a().pusher.then((function(t){t.channels.main.unbind("updatedLotteryOptions")}))})),t=function(t){return a().modal.show(I,{onsubmit:function(o){return a().store.createRecord("lottery").save(at({},o,{relationships:{post:t}}),{data:{include:"options,lottery_participants,lottery_participants.option"}}).then((function(o){var e;return null==(e=t.rawRelationship("lottery"))||null==e.push||e.push({type:"lottery",id:o.id()}),o}))}})},(0,r.extend)(nt(),"moderationControls",(function(o,e){!e.isHidden()&&e.canStartLottery()&&o.add("addLottery",m(w(),{icon:"fas fa-lottery",onclick:t.bind(this,e)},a().translator.trans("nodeloc-lottery.forum.moderation.add")))}))}))})(),module.exports=o})();
//# sourceMappingURL=forum.js.map